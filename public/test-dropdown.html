<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dropdown Mata Pelajaran</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Test Dropdown Mata Pelajaran</h1>
        
        <div class="alert alert-info">
            <strong>Langkah Testing:</strong>
            <ol>
                <li>Pilih unit dari dropdown</li>
                <li>Lihat di bawah untuk hasil testing</li>
                <li>Buka Console (F12) untuk melihat log detail</li>
            </ol>
        </div>

        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Pilih Unit Pendidikan</label>
                <select id="select-unit" class="form-control">
                    <option value="">-- Pilih Unit --</option>
                    <option value="1">Unit ID 1</option>
                    <option value="2">Unit ID 2</option>
                    <option value="3">Unit ID 3</option>
                </select>
            </div>
            <div class="col-md-8">
                <label class="form-label">Pilih Mata Pelajaran</label>
                <select id="select-subject" class="form-control" disabled>
                    <option value="">-- Pilih Mapel --</option>
                </select>
            </div>
        </div>

        <div class="mt-4">
            <h3>Test Results:</h3>
            <div id="test-results" class="border p-3 bg-light"></div>
        </div>

        <div class="mt-4">
            <h3>Quick Actions:</h3>
            <a href="/seed-dummy-data" class="btn btn-primary" target="_blank">Run Seeder</a>
            <a href="/debug-db" class="btn btn-info" target="_blank">Check Database</a>
            <button id="test-endpoint" class="btn btn-warning">Test Endpoint Directly</button>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            console.log('jQuery version:', $.fn.jquery);
            
            // Test endpoint directly
            $('#test-endpoint').on('click', function() {
                var unitId = $('#select-unit').val() || '1';
                var url = '/get-subjects/' + unitId;
                
                $('#test-results').html('<div class="spinner-border"></div> Testing endpoint: ' + url);
                console.log('Testing URL:', url);
                
                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log('SUCCESS! Data received:', data);
                        var html = '<div class="alert alert-success">✅ SUCCESS!</div>';
                        html += '<strong>Subjects found: ' + data.length + '</strong><br>';
                        html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                        $('#test-results').html(html);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('ERROR!', {
                            status: jqXHR.status,
                            statusText: jqXHR.statusText,
                            responseText: jqXHR.responseText,
                            textStatus: textStatus,
                            errorThrown: errorThrown
                        });
                        
                        var html = '<div class="alert alert-danger">❌ ERROR!</div>';
                        html += '<strong>Status:</strong> ' + jqXHR.status + ' ' + jqXHR.statusText + '<br>';
                        html += '<strong>Error:</strong> ' + textStatus + '<br>';
                        html += '<strong>Response:</strong><br>';
                        html += '<pre>' + jqXHR.responseText + '</pre>';
                        $('#test-results').html(html);
                    }
                });
            });

            // Handle unit change
            $('#select-unit').on('change', function() {
                var unitId = $(this).val();
                console.log('Unit changed to:', unitId);
                
                $('#select-subject').html('<option value="">-- Pilih Mapel --</option>').prop('disabled', true);
                $('#test-results').html('');
                
                if (!unitId) {
                    return;
                }
                
                var subjectsUrl = '/get-subjects/' + unitId;
                console.log('Fetching subjects from:', subjectsUrl);
                
                $('#test-results').html('<div class="spinner-border"></div> Loading...');
                
                $.ajax({
                    url: subjectsUrl,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log('Subjects received:', data);
                        
                        var html = '<div class="alert alert-success">✅ AJAX Success!</div>';
                        html += '<strong>Subjects found: ' + data.length + '</strong><br>';
                        
                        if (data.length === 0) {
                            $('#select-subject').html('<option value="">-- Tidak ada mapel --</option>').prop('disabled', true);
                            html += '<div class="alert alert-warning mt-2">Tidak ada mata pelajaran untuk unit ini. Silakan run seeder.</div>';
                        } else {
                            var opts = '<option value="">-- Pilih Mapel --</option>';
                            $.each(data, function(index, subject) {
                                var code = subject.code ? ' (' + subject.code + ')' : '';
                                opts += '<option value="'+subject.id+'" data-name="'+subject.name+'">'+subject.name + code +'</option>';
                                html += (index + 1) + '. ' + subject.name + (subject.code ? ' (' + subject.code + ')' : '') + '<br>';
                            });
                            $('#select-subject').html(opts).prop('disabled', false);
                        }
                        
                        $('#test-results').html(html);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('AJAX Error:', {
                            status: jqXHR.status,
                            statusText: jqXHR.statusText,
                            responseText: jqXHR.responseText,
                            textStatus: textStatus,
                            errorThrown: errorThrown
                        });
                        
                        var html = '<div class="alert alert-danger">❌ AJAX Failed!</div>';
                        html += '<strong>Status:</strong> ' + jqXHR.status + ' ' + jqXHR.statusText + '<br>';
                        html += '<strong>Error:</strong> ' + textStatus + '<br>';
                        html += '<strong>URL:</strong> ' + subjectsUrl + '<br>';
                        html += '<strong>Response:</strong><br>';
                        html += '<pre>' + jqXHR.responseText + '</pre>';
                        
                        $('#test-results').html(html);
                        $('#select-subject').html('<option value="">Error loading subjects</option>');
                    }
                });
            });
        });
    </script>
</body>
</html>
